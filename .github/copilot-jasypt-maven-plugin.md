# Module playbook: `jasypt-maven-plugin`

This module is a **Maven plugin** (goal prefix `jasypt`) that:
- boots a tiny Spring Boot context
- obtains a `StringEncryptor` (configured the same way as jasypt-spring-boot)
- encrypts/decrypts either whole files (placeholder replacement) or single values

---

## 1) Public contract: goals + parameters

Treat these as stable API. Any behavior/parameter change needs docs + tests updates.

Goals (as documented in `jasypt-maven-plugin/README.md`):
- `encrypt`
- `decrypt`
- `encrypt-value`
- `decrypt-value`
- `reencrypt`
- `upgrade`
- `load`

Core parameters (from README + `@Parameter` declarations across mojos):
- `jasypt.plugin.path`
- `jasypt.plugin.value`
- `jasypt.plugin.keyPrefix`
- `jasypt.plugin.encrypt.prefix` (default `ENC(`)
- `jasypt.plugin.encrypt.suffix` (default `)`)
- `jasypt.plugin.decrypt.prefix` (default `DEC(`)
- `jasypt.plugin.decrypt.suffix` (default `)`)
- `jasypt.plugin.old.*` (used for reencrypt/upgrade flows)

---

## 2) Where it starts (entrypoints)

### Spring context bootstrapping
- `mojo/AbstractJasyptMojo`
  - `execute()` creates a `SpringApplicationBuilder` with:
    - `.sources(Application.class)`
    - `.bannerMode(OFF)`
    - `spring.config.location=optional:file:./src/main/resources/`
  - captures the `Environment`
  - obtains `StringEncryptor` from the context
  - calls `run(new EncryptionService(encryptor), context, ...)`

Implication:
- The plugin inherits jasypt configuration using Spring Boot’s property loading.
- Keep this context lightweight; don’t add logging implementations (the module intentionally excludes logback/log4j and uses `slf4j-simple`).

### Placeholder encryption/decryption logic
- `encrypt/EncryptionService`
  - does regex-based placeholder replacement with `Pattern.DOTALL`
  - escapes regex meta-chars in prefix/suffix via `quoteRegExSpecialChars`
  - replacement is built manually via `Matcher#appendReplacement` + `StringBuffer` to avoid regex-group expansion issues

---

## 3) Behavioral invariants (don’t break these)

### File-vs-console semantics
- `encrypt` mutates files (writes encrypted output)
- `decrypt` is read-only (prints decrypted output; does not write)
- `load` loads and decrypts properties into Maven project properties

### Prefix/suffix behavior
- Defaults must remain `ENC(` / `)` and `DEC(` / `)`
- Prefix/suffix can contain regex special characters; escaping is intentional and must remain

### Multi-line placeholders
- DOTALL matching is intentional so placeholders can span lines

### Security and logs
- Don’t log secrets.
  - `EncryptionService` currently logs replacements at `DEBUG` including matched plaintext; that’s risky in real builds.
  - Avoid adding any new logging that prints plaintext or decrypted values.
  - Prefer logging counts/paths and keep value-level logging disabled by default.

---

## 4) Common edge cases (test mentally when changing regex logic)

- Multiple placeholders in one file
- Nested/adjacent placeholders
- Empty placeholder payloads
- Prefix/suffix that include characters like `[` `]` `(` `)` `.` `*` `?` etc.
- Large files (avoid quadratic string operations)

---

## 5) Validation

Run:
- plugin module tests/build: `mvn -pl jasypt-maven-plugin -am test`
- full repo: `mvn test`

When you change goal behavior or parameters:
- update `jasypt-maven-plugin/README.md`
- ensure the plugin descriptor still matches (generated by `maven-plugin-plugin`)
